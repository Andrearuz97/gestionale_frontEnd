<div class="container my-4">
  <h2 class="mb-4 text-center">📋 Gestione Prenotazioni</h2>

  <!-- Barra filtri -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form class="row g-3 align-items-center">
        <div class="col-md-4 position-relative">
          <label for="inputNome" class="form-label fw-bold">👤 Nome cliente</label>
          <input
            id="inputNome"
            list="listaNomi"
            type="text"
            class="form-control form-control-sm"
            placeholder="Es. Maria Rossi"
            [(ngModel)]="filtroNome"
            name="filtroNome"
          />
          <datalist id="listaNomi">
            <option *ngFor="let nome of nomiClienti" [value]="nome"></option>
          </datalist>
        </div>

        <div class="col-md-3">
          <label for="inputData" class="form-label fw-bold">📅 Data prenotazione</label>
          <input
            id="inputData"
            type="date"
            class="form-control form-control-sm"
            [(ngModel)]="filtroData"
            name="filtroData"
          />
        </div>

        <div class="col-md-5 d-flex align-items-end justify-content-end gap-2 flex-wrap">
          <button type="button" class="btn btn-primary btn-sm" (click)="applicaFiltri()" title="Filtra">
            🔍 Filtra
          </button>
          <button type="button" class="btn btn-secondary btn-sm" (click)="resetFiltri()" title="Reset">
            ♻️ Reset
          </button>
          <button type="button" class="btn btn-dark btn-sm" (click)="caricaPrenotazioni()" title="Refresh">
            🔄 Refresh
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border" role="status"><span class="visually-hidden">Caricamento...</span></div>
  </div>

  <!-- Errore -->
  <div *ngIf="error" class="alert alert-danger text-center">{{ error }}</div>

  <!-- Tabella Responsive -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover text-center align-middle" *ngIf="prenotazioni.length > 0">
  <thead class="table-light">
    <tr>
      <th>ID</th>
      <th>Cliente</th>
      <th>Telefono</th>
      <th>Email</th>
      <th>Nascita</th>
      <th>Note</th>
      <th>Data</th>
      <th>Trattamento</th>
      <th>Stato</th>
      <th>Azioni</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let p of prenotazioni">
      <td>{{ p.id }}</td>

      <!-- Cliente -->
      <td>
        <ng-container *ngIf="p.editing; else nomeStatico">
          <input [(ngModel)]="p.cliente.nome" class="form-control form-control-sm mb-1" placeholder="Nome" name="nome{{p.id}}" />
          <input [(ngModel)]="p.cliente.cognome" class="form-control form-control-sm" placeholder="Cognome" name="cognome{{p.id}}" />
        </ng-container>
        <ng-template #nomeStatico>
          {{ p.cliente.nome || 'N/A' }} {{ p.cliente.cognome || '' }}
        </ng-template>
      </td>

      <!-- Telefono -->
      <td>
        <ng-container *ngIf="p.editing; else telefonoStatico">
          <input [(ngModel)]="p.cliente.telefono" class="form-control form-control-sm" name="tel{{p.id}}" />
        </ng-container>
        <ng-template #telefonoStatico>{{ p.cliente.telefono }}</ng-template>
      </td>

      <!-- Email -->
      <td>
        <ng-container *ngIf="p.editing; else emailStatico">
          <input [(ngModel)]="p.cliente.email" class="form-control form-control-sm" name="email{{p.id}}" />
        </ng-container>
        <ng-template #emailStatico>{{ p.cliente.email }}</ng-template>
      </td>

      <!-- Data di nascita -->
      <td>
        <ng-container *ngIf="p.editing; else nascitaStatico">
          <input type="date" [(ngModel)]="p.cliente.dataNascita" class="form-control form-control-sm" name="nascita{{p.id}}" />
        </ng-container>
        <ng-template #nascitaStatico>{{ p.cliente.dataNascita }}</ng-template>
      </td>

      <!-- Note -->
      <td>
        <ng-container *ngIf="p.editing; else noteStatico">
          <input [(ngModel)]="p.note" class="form-control form-control-sm" name="note{{p.id}}" />
        </ng-container>
        <ng-template #noteStatico>{{ p.note }}</ng-template>
      </td>

      <!-- Data -->
      <td>
        <ng-container *ngIf="p.editing; else dataStatico">
          <input type="datetime-local" [(ngModel)]="p.dataOra" class="form-control form-control-sm" name="dataOra{{p.id}}" />
        </ng-container>
        <ng-template #dataStatico>{{ p.dataOra | date:'short' }}</ng-template>
      </td>

      <!-- Trattamento -->
      <td>
        <ng-container *ngIf="p.editing; else trattamentoStatico">
          <select [(ngModel)]="p.trattamento.id" class="form-select form-select-sm" name="trattamento{{p.id}}">
            <option *ngFor="let t of trattamenti" [value]="t.id">{{ t.nome }}</option>
          </select>
        </ng-container>
        <ng-template #trattamentoStatico>{{ p.trattamento.nome }}</ng-template>
      </td>

      <!-- Stato -->
      <td>
        <ng-container *ngIf="p.editing; else statoBadge">
          <select
            [(ngModel)]="p.stato"
            class="form-select form-select-sm text-white"
            name="stato{{p.id}}"
            [ngClass]="{
              'bg-info': p.stato === 'CREATA',
              'bg-warning text-dark': p.stato === 'CONFERMATA',
              'bg-danger': p.stato === 'ANNULLATA',
              'bg-success': p.stato === 'COMPLETATA'
            }"
            (change)="aggiornaStatoPrenotazione(p)">
            <option *ngFor="let s of statiPossibili" [value]="s">{{ s }}</option>
          </select>
        </ng-container>
        <ng-template #statoBadge>
          <span class="badge"
            [ngClass]="{
              'bg-info text-dark': p.stato === 'CREATA',
              'bg-warning text-dark': p.stato === 'CONFERMATA',
              'bg-danger text-white': p.stato === 'ANNULLATA',
              'bg-success text-white': p.stato === 'COMPLETATA'
            }">
            {{ p.stato }}
          </span>
        </ng-template>
      </td>

      <!-- Azioni -->
      <td>
        <div class="d-flex flex-wrap gap-1 justify-content-center">
          <button
            class="btn btn-primary btn-sm"
            (click)="p.editing = !p.editing"
            [title]="p.editing ? 'Annulla Modifica' : 'Modifica'">
            ✏️
          </button>
          <button
            *ngIf="p.editing"
            class="btn btn-success btn-sm"
            (click)="salvaPrenotazione(p); p.editing = false"
            title="Salva">
            💾
          </button>
          <button
            class="btn btn-danger btn-sm"
            (click)="cancellaPrenotazione(p.id)"
            title="Elimina">
            🗑️
          </button>
        </div>
      </td>
    </tr>
  </tbody>
</table>

  </div>

  <div *ngIf="prenotazioni.length === 0 && !loading" class="alert alert-info text-center">
    Nessuna prenotazione trovata.
  </div>
</div>

<!-- prenotazioni.component.html -->
<div class="container my-4">
  <h2 class="mb-4 text-center">ğŸ“‹ Gestione Prenotazioni</h2>

  <!-- Barra filtri -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form class="row g-3 align-items-center">
        <div class="col-md-4 position-relative">
          <label for="inputNome" class="form-label fw-bold">ğŸ‘¤ Nome cliente</label>
   <input
  id="inputNome"
  type="text"
  class="form-control form-control-sm"
  placeholder="Trova prenotazione"
  [(ngModel)]="filtroNome"
  name="filtroNome"
  (keydown.enter)="applicaFiltri()"
  autocomplete="off" />

        </div>

        <div class="col-md-3">
          <label for="inputData" class="form-label fw-bold">ğŸ—“ï¸ Data prenotazione</label>
          <input id="inputData" type="date" class="form-control form-control-sm" [(ngModel)]="filtroData" name="filtroData" />
        </div>

        <div class="col-md-5 d-flex align-items-end justify-content-end gap-2 flex-wrap">
          <button type="button" class="btn btn-primary btn-sm" (click)="applicaFiltri()" title="Filtra">
            ğŸ” Filtra
          </button>
          <button type="button" class="btn btn-secondary btn-sm" (click)="resetFiltri()" title="Reset">
            â™»ï¸ Reset
          </button>
          <button type="button" class="btn btn-dark btn-sm" (click)="caricaPrenotazioni()" title="Refresh">
            ğŸ”„ Refresh
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border" role="status"><span class="visually-hidden">Caricamento...</span></div>
  </div>

  <!-- Errore -->
  <div *ngIf="error" class="alert alert-danger text-center">{{ error }}</div>

  <!-- Tabella -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover text-center align-middle" *ngIf="prenotazioni.length > 0">
      <thead class="table-light">
  <tr>
    <th>ID</th>
    <th>Cliente</th>
    <th>Telefono</th>
    <th>Data Appuntamento</th>
    <th>Data Prenotazione</th> <!-- âœ… nuova colonna -->
    <th>Stato</th>
    <th>Azioni</th>
  </tr>
</thead>
<tbody>
  <tr *ngFor="let p of prenotazioni">
    <td>{{ p.id }}</td>

    <!-- Cliente -->
    <td>
      <ng-container *ngIf="p.editing; else nomeStatico">
        <input [(ngModel)]="p.cliente.nome" class="form-control form-control-sm mb-1" placeholder="Nome" name="nome{{p.id}}" />
        <input [(ngModel)]="p.cliente.cognome" class="form-control form-control-sm" placeholder="Cognome" name="cognome{{p.id}}" />
      </ng-container>
      <ng-template #nomeStatico>
        {{ p.cliente.nome || 'N/A' }} {{ p.cliente.cognome || '' }}
      </ng-template>
    </td>

    <td>
      <ng-container *ngIf="p.editing; else telefonoStatico">
        <input [(ngModel)]="p.cliente.telefono" class="form-control form-control-sm" name="tel{{p.id}}" />
      </ng-container>
      <ng-template #telefonoStatico>{{ p.cliente.telefono }}</ng-template>
    </td>

    <td>
      <ng-container *ngIf="p.editing; else dataStatico">
        <input type="datetime-local" [(ngModel)]="p.dataOra" class="form-control form-control-sm" name="dataOra{{p.id}}" />
      </ng-container>
      <ng-template #dataStatico>{{ p.dataOra | date:'short' }}</ng-template>
    </td>

    <!-- âœ… Nuova colonna per Data Prenotazione -->
    <td>{{ p.dataPrenotazione | date:'short' }}</td>

    <td>
      <ng-container *ngIf="p.editing; else statoBadge">
        <select [(ngModel)]="p.stato" class="form-select form-select-sm text-white" name="stato{{p.id}}"
          [ngClass]="{
            'bg-info': p.stato === 'CREATA',
            'bg-warning text-dark': p.stato === 'CONFERMATA',
            'bg-danger': p.stato === 'ANNULLATA',
            'bg-success': p.stato === 'COMPLETATA'
          }"
          (change)="aggiornaStatoPrenotazione(p)">
          <option *ngFor="let s of statiPossibili" [value]="s">{{ s }}</option>
        </select>
      </ng-container>
      <ng-template #statoBadge>
        <span class="badge"
          [ngClass]="{
            'bg-info text-dark': p.stato === 'CREATA',
            'bg-warning text-dark': p.stato === 'CONFERMATA',
            'bg-danger text-white': p.stato === 'ANNULLATA',
            'bg-success text-white': p.stato === 'COMPLETATA'
          }">
          {{ p.stato }}
        </span>
      </ng-template>
    </td>

    <td>
      <div class="d-flex flex-wrap gap-1 justify-content-center">
        <button class="btn btn-primary btn-sm" (click)="p.editing = !p.editing" [title]="p.editing ? 'Annulla Modifica' : 'Modifica'">
          âœï¸
        </button>
        <button *ngIf="p.editing" class="btn btn-success btn-sm" (click)="salvaPrenotazione(p); p.editing = false" title="Salva">
          ğŸ’¾
        </button>
        <button class="btn btn-danger btn-sm" (click)="cancellaPrenotazione(p.id)" title="Elimina">
          ğŸ—‘ï¸
        </button>
        <button class="btn btn-info btn-sm" (click)="apriDettagli(p)" title="Dettagli cliente">
          ğŸ”
        </button>
      </div>
    </td>
  </tr>
</tbody>

    </table>
  </div>

  <div *ngIf="prenotazioni.length === 0 && !loading" class="alert alert-info text-center">
    Nessuna prenotazione trovata.
  </div>

  <!-- Modale Dettagli -->
  <div class="modal fade show" tabindex="-1" style="display:block; background:rgba(0,0,0,0.5);" *ngIf="prenotazioneDettaglio">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content rounded-4 shadow">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">ğŸ“„ Dettagli Prenotazione</h5>
          <button type="button" class="btn-close" aria-label="Chiudi" (click)="prenotazioneDettaglio = null"></button>
        </div>
        <div class="modal-body">
          <p><strong>ğŸ§‘â€ğŸ“ Cliente:</strong> {{ prenotazioneDettaglio.cliente.nome }} {{ prenotazioneDettaglio.cliente.cognome }}</p>
          <p><strong>ğŸ“ Telefono:</strong> {{ prenotazioneDettaglio.cliente.telefono }}</p>
          <p><strong>ğŸ“§ Email:</strong> {{ prenotazioneDettaglio.cliente.email }}</p>
          <p><strong>ğŸ‚ Nascita:</strong> {{ prenotazioneDettaglio.cliente.dataNascita }}</p>
          <p><strong>ğŸ“œ Note:</strong> {{ prenotazioneDettaglio.note }}</p>
          <p><strong>ğŸ«‹ Trattamento:</strong> {{ prenotazioneDettaglio.trattamento.nome }}</p>
          <p><strong>ğŸ—“ï¸ Prenotato il:</strong> {{ prenotazioneDettaglio.dataPrenotazione | date:'short' }}</p>
          <p><strong>ğŸ—“ï¸ Data:</strong> {{ prenotazioneDettaglio.dataOra | date:'short' }}</p>
          <p><strong>ğŸ”¹ Stato:</strong> {{ prenotazioneDettaglio.stato }}</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="prenotazioneDettaglio = null">Chiudi</button>
        </div>
      </div>
    </div>
  </div>
</div>
